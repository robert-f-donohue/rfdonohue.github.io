---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import Tag from "../../components/Tag.astro";
import ButtonLink from "../../components/ButtonLink.astro";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((p) => ({ params: { slug: p.slug }, props: { p } }));
}

const { p } = Astro.props;
const { Content } = await p.render();

const links = [
  p.data.website ? { label: "Website", href: p.data.website } : null,
  p.data.writeup ? { label: "Write-up", href: p.data.writeup } : null,
  p.data.demo ? { label: "Demo", href: p.data.demo } : null,
  p.data.paper ? { label: "Paper", href: p.data.paper } : null,
  p.data.slides ? { label: "Slides", href: p.data.slides } : null,
].filter(Boolean) as { label: string; href: string }[];
---

<SiteLayout title={p.data.title} description={p.data.description}>
  <header class="space-y-3">
    <div class="flex flex-wrap items-center gap-2 text-xs text-muted">
      <span class="rounded-full border border-border bg-panel/60 px-2 py-0.5 capitalize">{p.data.category}</span>
      <span class="rounded-full border border-border bg-panel/60 px-2 py-0.5 capitalize">{p.data.status}</span>
    </div>

    <h1 class="text-4xl font-bold tracking-tight">{p.data.title}</h1>
    <p class="text-muted max-w-3xl">{p.data.description}</p>
  </header>

  <div class="mt-10 grid gap-8 lg:grid-cols-3">
    <!-- Main narrative -->
    <article class="lg:col-span-2">
      <div class="prose prose-slate dark:prose-invert max-w-none">
        <Content />
      </div>
    </article>

    <!-- Sidebar -->
    <aside class="lg:col-span-1">
      <div class="sticky top-24 space-y-4">
        <div class="rounded-2xl border border-border bg-panel/60 p-5">
          <div class="text-sm font-semibold text-fg">At a glance</div>

          {p.data.tags?.length ? (
            <div class="mt-3">
              <div class="text-xs text-muted">Tags</div>
              <div class="mt-2 flex flex-wrap gap-2">
                {p.data.tags.map((t) => <Tag label={t} />)}
              </div>
            </div>
          ) : null}

          {p.data.highlights?.length ? (
            <div class="mt-5">
              <div class="text-xs text-muted">Highlights</div>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-muted">
                {p.data.highlights.map((h) => <li>{h}</li>)}
              </ul>
            </div>
          ) : null}

          {links.length ? (
            <div class="mt-5">
              <div class="text-xs text-muted">Links</div>
              <div class="mt-2 flex flex-col gap-2">
                {links.map((l) => (
                  <a
                    class="rounded-xl border border-border bg-bg/50 px-3 py-2 text-sm text-fg hover:bg-panel"
                    href={l.href}
                    target="_blank"
                  >
                    {l.label} →
                  </a>
                ))}
              </div>
            </div>
          ) : null}

          <div class="mt-5">
            <ButtonLink href="/projects" variant="ghost">← Back to projects</ButtonLink>
          </div>
        </div>

        <div class="rounded-2xl border border-border bg-bg/50 p-5">
          <div class="text-sm font-semibold text-fg">Want the thinking?</div>
          <p class="mt-2 text-sm text-muted">
            Related write-ups live in <a class="underline" href="/blog">Writing</a>.
          </p>
        </div>
      </div>
    </aside>
  </div>
</SiteLayout>
